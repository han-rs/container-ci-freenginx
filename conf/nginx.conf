# Nginx main configuration

# daemon off;
# pid /opt/nginx/logs/nginx.pid;
# user nginx nginx;

worker_processes auto;
# worker_cpu_affinity auto;
# worker_priority -20;
worker_rlimit_nofile 65536;

# lock_file /opt/nginx/logs/nginx.lock;
pcre_jit on;

events {
    worker_connections 8192;
    multi_accept on;
    accept_mutex on;
    use epoll;
}

http {
    include mime.types;

    # === Temp ===
    # client_body_temp_path /opt/nginx/temp/http-client-body;
    # proxy_temp_path /opt/nginx/temp/http-proxy;
    # fastcgi_temp_path /opt/nginx/temp/http-fastcgi;
    # uwsgi_temp_path /opt/nginx/temp/http-uwsgi;
    # scgi_temp_path /opt/nginx/temp/http-scgi;

    # set_real_ip_from 0.0.0.0/0;
    # real_ip_header CF-Connecting-IP;

    default_type application/octet-stream;
    charset utf-8;

    # === Features ===
    http2 on;
    http3 on;
    http3_hq on;

    # === TCP ===
    tcp_nopush on;
    tcp_nodelay on;
    sendfile on;
    aio threads;

    # === QUIC ===
    http3_max_concurrent_streams 768;
    http3_stream_buffer_size 512k;
    quic_active_connection_id_limit 64;
    quic_retry on;
    quic_gso on;

    # === SSL/TLS ===
    ssl_protocols TLSv1.3 TLSv1.2;

    ssl_ciphers TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256:ECDH+AESGCM+AES256:ECDH+CHACHA20;
    ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256:ECDH+AESGCM+AES256:ECDH+CHACHA20;
    ssl_conf_command Options ServerPreference;
    ssl_prefer_server_ciphers on;

    ssl_ecdh_curve X25519MLKEM768:X25519:SecP384r1MLKEM1024:SecP256r1MLKEM768:secp521r1:secp384r1:secp256r1;

    ssl_buffer_size 4k;

    ssl_dhparam /opt/nginx/conf/dhparam.pem;

    ssl_session_cache shared:SSL:60m;
    ssl_session_tickets off;
    ssl_session_timeout 1440m;

    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_ocsp on;
    ssl_ocsp_cache shared:ocspSSL:60m;
    resolver 8.8.8.8 1.1.1.1 valid=60s;
    resolver_timeout 2s;

    ssl_verify_depth 2;

    ssl_early_data on;
    proxy_set_header Early-Data $ssl_early_data;

    # === Compression ===
    gzip on;
    gzip_buffers 16 8k;
    gzip_comp_level 6;
    gzip_http_version 1.1;
    gzip_min_length 1k;
    gzip_proxied any;
    gzip_types
        text/plain
        text/css
        application/json
        application/javascript
        text/xml
        application/xml
        application/xml+rss
        text/javascript;
    gzip_vary on;

    brotli on;
    brotli_comp_level 6;
    brotli_static on;
    brotli_types
        application/atom+xml
        application/javascript
        application/json
        application/vnd.api+json
        application/rss+xml
        application/vnd.ms-fontobject
        application/x-font-opentype
        application/x-font-truetype
        application/x-font-ttf
        application/x-javascript
        application/xhtml+xml
        application/xml
        font/eot
        font/opentype
        font/otf
        font/truetype
        image/svg+xml
        image/vnd.microsoft.icon
        image/x-icon
        image/x-win-bitmap
        text/css
        text/javascript
        text/plain
        text/xml;

    # === HTTP ===
    send_timeout 60s;
    keepalive_timeout 30s;

    client_body_timeout 120s;
    client_body_buffer_size 16M;
    client_max_body_size 20M;

    proxy_buffering on;
    proxy_buffer_size 32k;
    proxy_busy_buffers_size 64k;
    proxy_buffers 512 8k;
    proxy_max_temp_file_size 0;
    proxy_intercept_errors on;
    proxy_read_timeout 300s;
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    fastcgi_read_timeout 300s;

    reset_timedout_connection off;

    # === Log ===
    log_format details '[$time_local][$status]|[Client] "$remote_addr" |[Host] "$host" |[Refer] "$http_referer" |[UA] "$http_user_agent" |[REQ] "$request" |[CONNECT] "$connection_requests" |[TIME] "$request_time" |[LENGTH] "$bytes_sent" |[UPSTREAM] "$upstream_addr" |[U_HEAD_TIME] "$upstream_header_time" |[U_CON_TIME] "$upstream_connect_time" |[U_RSP_TIME] "$upstream_response_time" |[U_STATUS] "$upstream_status" |[U_LENGTH] "$upstream_response_length"';
    log_format details_pp '[$time_local][$status]|[Client] "$proxy_protocol_addr" |[Host] "$host" |[Refer] "$http_referer" |[UA] "$http_user_agent" |[REQ] "$request" |[CONNECT] "$connection_requests" |[TIME] "$request_time" |[LENGTH] "$bytes_sent" |[UPSTREAM] "$upstream_addr" |[U_HEAD_TIME] "$upstream_header_time" |[U_CON_TIME] "$upstream_connect_time" |[U_RSP_TIME] "$upstream_response_time" |[U_STATUS] "$upstream_status" |[U_LENGTH] "$upstream_response_length"';
    access_log off;
    error_log /dev/stdout error;

    # === Others ===
    limit_conn_zone $binary_remote_addr zone=perip:10m;
    limit_conn_zone $server_name zone=perserver:10m;
    server_tokens off;
    types_hash_max_size 4096;

    include /opt/nginx/conf/conf.d/*.conf;
}
