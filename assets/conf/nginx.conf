# Nginx main configuration

# daemon off;
# pid /opt/freenginx/temp/nginx.pid;
# user nginx nginx;

worker_processes auto;
# worker_cpu_affinity auto;
# worker_priority -20;
worker_rlimit_nofile 65536;

# lock_file /opt/freenginx/temp/nginx.lock;
pcre_jit on;

events {
    worker_connections 8192;
    multi_accept on;
    accept_mutex on;
    use epoll;
}

http {
    # * The directory for storing temporary files.
    # client_body_temp_path /opt/freenginx/temp/http-client-body;
    # proxy_temp_path /opt/freenginx/temp/http-proxy;
    # fastcgi_temp_path /opt/freenginx/temp/http-fastcgi;
    # uwsgi_temp_path /opt/freenginx/temp/http-uwsgi;
    # scgi_temp_path /opt/freenginx/temp/http-scgi;

    # * File I/O features
    sendfile on;
    aio threads;

    # * TCP features
    tcp_nopush on;
    tcp_nodelay on;

    # * HTTP/2 configuration
    http2 on;

    # * HTTP/3 (QUIC) configuration
    http3 on;
    http3_hq on;
    http3_max_concurrent_streams 768;
    http3_stream_buffer_size 512k;
    quic_active_connection_id_limit 64;
    quic_retry on;
    quic_gso on;

    # * === Start: SSL/TLS configuration ===

    # * Enable TLS 1.3 and TLS 1.2.
    ssl_protocols TLSv1.3 TLSv1.2;

    # * Let the client choose the cipher suite order, which is recommended by Mozilla and Cloudflare.
    # *
    # * See https://github.com/mozilla/server-side-tls/issues/260
    ssl_prefer_server_ciphers off;
    # * Specify the cipher suites for TLS 1.2 and earlier.
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305;
    # * Specify the cipher suites for TLS 1.3.
    ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256;
    # * Specify the supported groups for ECDHE and ECDH key exchange.
    ssl_ecdh_curve X25519MLKEM768:X25519:SecP384r1MLKEM1024:SecP256r1MLKEM768:secp521r1:secp384r1:secp256r1;
    # * Specify a file with DH parameters for DHE ciphers.
    ssl_dhparam /opt/freenginx/ssl/dhparam.pem;

    # * Set the size of the buffer used for sending data.
    ssl_buffer_size 4k;

    # * SSL session configuration
    ssl_session_cache shared:SSL:60m;
    ssl_session_tickets off;
    ssl_session_timeout 1440m;

    # * SSL certificate related configuration
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_ocsp on;
    ssl_ocsp_cache shared:ocspSSL:60m;
    resolver 8.8.8.8 1.1.1.1 valid=60s;
    resolver_timeout 2s;
    ssl_verify_depth 2;
    # ssl_certificate_compression on; # freenginx does not support this directive yet.

    # * Other SSL features
    ssl_early_data on;
    proxy_set_header Early-Data $ssl_early_data;

    # * === End: SSL/TLS configuration ===

    # * === Start: general HTTP server configuration ===

    # * Set the default character encoding for responses.
    charset utf-8;
    # * Set the default MIME type.
    default_type application/octet-stream;
    # * Set the MIME types for different file extensions.
    include mime.types;
    # * Compression: gzip
    gzip on;
    gzip_buffers 16 8k;
    gzip_comp_level 6;
    gzip_http_version 1.1;
    gzip_min_length 1k;
    gzip_proxied any;
    gzip_types
        text/plain
        text/css
        application/json
        application/javascript
        text/xml
        application/xml
        application/xml+rss
        text/javascript;
    gzip_vary on;
    # * Compression: brotli
    brotli on;
    brotli_comp_level 6;
    brotli_static on;
    brotli_types
        application/atom+xml
        application/javascript
        application/json
        application/vnd.api+json
        application/rss+xml
        application/vnd.ms-fontobject
        application/x-font-opentype
        application/x-font-truetype
        application/x-font-ttf
        application/x-javascript
        application/xhtml+xml
        application/xml
        font/eot
        font/opentype
        font/otf
        font/truetype
        image/svg+xml
        image/vnd.microsoft.icon
        image/x-icon
        image/x-win-bitmap
        text/css
        text/javascript
        text/plain
        text/xml;
    # * Buffering configuration for proxying requests to upstream servers.
    proxy_buffering on;
    proxy_buffer_size 32k;
    proxy_busy_buffers_size 64k;
    proxy_buffers 512 8k;
    proxy_max_temp_file_size 0;
    proxy_intercept_errors on;
    # * Threshold for buffering client request body in memory.
    client_body_buffer_size 128k;
    # * Allow large file uploads (e.g., for file sharing or web applications).
    client_max_body_size 100m;

    # * === End: general HTTP server configuration ===

    # * === Start: client session configuration ===

    reset_timedout_connection off;

    send_timeout 60s;
    keepalive_timeout 30s;

    client_body_timeout 120s;

    proxy_read_timeout 300s;
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;

    fastcgi_read_timeout 300s;

    # * === End: session configuration ===

    # * === Start: logging configuration ===

    access_log off;
    error_log /dev/stdout error;

    log_format details '[$time_local][$status]|[Client] "$remote_addr" |[Host] "$host" |[Refer] "$http_referer" |[UA] "$http_user_agent" |[REQ] "$request" |[CONNECT] "$connection_requests" |[TIME] "$request_time" |[LENGTH] "$bytes_sent" |[UPSTREAM] "$upstream_addr" |[U_HEAD_TIME] "$upstream_header_time" |[U_CON_TIME] "$upstream_connect_time" |[U_RSP_TIME] "$upstream_response_time" |[U_STATUS] "$upstream_status" |[U_LENGTH] "$upstream_response_length"';
    log_format details_proxy '[$time_local][$status]|[Client] "$proxy_protocol_addr" |[Host] "$host" |[Refer] "$http_referer" |[UA] "$http_user_agent" |[REQ] "$request" |[CONNECT] "$connection_requests" |[TIME] "$request_time" |[LENGTH] "$bytes_sent" |[UPSTREAM] "$upstream_addr" |[U_HEAD_TIME] "$upstream_header_time" |[U_CON_TIME] "$upstream_connect_time" |[U_RSP_TIME] "$upstream_response_time" |[U_STATUS] "$upstream_status" |[U_LENGTH] "$upstream_response_length"';

    # * === End: logging configuration ===

    # * === Start: other configuration ===
    
    # * Extract real IP from request header (use with caution).
    # set_real_ip_from 127.0.0.0/8;
    # real_ip_header X-Forwarded-For;

    # * Limit the number of connections per IP and per server to prevent abuse.
    limit_conn_zone $binary_remote_addr zone=perip:10m;
    limit_conn_zone $server_name zone=perserver:10m;

    # * Hide nginx version information for security reasons.
    server_tokens off;

    types_hash_max_size 4096;

    # * === End: other configuration ===

    include /opt/freenginx/conf/conf.d/*.conf;
}
